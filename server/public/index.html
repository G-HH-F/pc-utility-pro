<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PC Utility Pro - Support Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0a0f 0%, #12121a 100%);
      color: #fff;
      min-height: 100vh;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 30px;
    }

    .logo { display: flex; align-items: center; gap: 12px; }
    .logo h1 { font-size: 24px; font-weight: 600; }
    .logo span { font-size: 28px; }

    .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-email { color: #888; font-size: 14px; }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }

    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .btn-secondary:hover { background: rgba(255,255,255,0.15); }

    /* Login Screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }

    .login-box {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-box h2 { margin-bottom: 8px; }
    .login-box p { color: #888; margin-bottom: 24px; }

    .login-box input {
      width: 100%;
      padding: 14px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 15px;
      margin-bottom: 16px;
    }

    .login-box input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-box .btn { width: 100%; }

    /* Dashboard */
    .dashboard { display: none; }
    .dashboard.active { display: block; }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #00d2d3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label { color: #888; font-size: 14px; margin-top: 4px; }

    /* Sessions */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-header h2 { font-size: 18px; }

    .sessions-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .session-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .session-card:hover {
      background: rgba(255,255,255,0.08);
      transform: translateX(4px);
    }

    .session-info h3 { font-size: 16px; margin-bottom: 4px; }
    .session-info p { color: #888; font-size: 13px; }

    .session-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .session-status.waiting {
      background: rgba(254, 202, 87, 0.2);
      color: #feca57;
    }

    .session-status.active {
      background: rgba(0, 210, 211, 0.2);
      color: #00d2d3;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state span { font-size: 48px; display: block; margin-bottom: 16px; }

    /* Join Session Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: #1a1a2e;
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
    }

    /* Support Chat */
    .support-chat {
      display: none;
      height: calc(100vh - 120px);
      flex-direction: column;
    }

    .support-chat.active { display: flex; }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 16px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .message {
      margin-bottom: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 80%;
    }

    .message.user {
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin-left: auto;
    }

    .message.support {
      background: rgba(255,255,255,0.1);
    }

    .message-meta {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      margin-top: 4px;
    }

    .chat-input-row {
      display: flex;
      gap: 12px;
    }

    .chat-input-row input {
      flex: 1;
      padding: 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 15px;
    }

    .system-info-panel {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .system-info-panel h4 {
      font-size: 14px;
      color: #888;
      margin-bottom: 12px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }

    .info-item {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: 8px;
    }

    .info-item label { font-size: 11px; color: #888; display: block; }
    .info-item span { font-size: 14px; font-weight: 500; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <span>üñ•Ô∏è</span>
        <h1>PC Utility Pro</h1>
      </div>
      <div class="user-info" id="user-info" style="display: none;">
        <span class="user-email" id="user-email"></span>
        <button class="btn btn-secondary" onclick="logout()">Sign Out</button>
      </div>
    </header>

    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
      <div class="login-box">
        <h2>Support Dashboard</h2>
        <p>Sign in to help your users</p>
        <input type="email" id="email-input" placeholder="Enter your email">
        <button class="btn btn-primary" onclick="requestMagicLink()">Send Sign-In Link</button>
        <p id="login-message" style="margin-top: 16px; color: #00d2d3;"></p>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat-active">0</div>
          <div class="stat-label">Active Sessions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-waiting">0</div>
          <div class="stat-label">Waiting for Help</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-connected">0</div>
          <div class="stat-label">Being Helped</div>
        </div>
      </div>

      <!-- Join Session -->
      <div class="section-header">
        <h2>Support Sessions</h2>
        <button class="btn btn-primary" onclick="showJoinModal()">Join with Code</button>
      </div>

      <div class="sessions-list" id="sessions-list">
        <div class="empty-state">
          <span>üí§</span>
          <p>No active sessions. Users will appear here when they request help.</p>
        </div>
      </div>
    </div>

    <!-- Support Chat -->
    <div class="support-chat" id="support-chat">
      <div class="chat-header">
        <div>
          <h2>Support Session</h2>
          <p id="chat-session-id" style="color: #888; font-size: 13px;"></p>
        </div>
        <button class="btn btn-secondary" onclick="leaveSession()">Leave Session</button>
      </div>

      <div class="system-info-panel">
        <h4>System Information</h4>
        <div class="info-grid" id="system-info-grid">
          <!-- Populated dynamically -->
        </div>
      </div>

      <div class="chat-messages" id="chat-messages"></div>

      <div class="chat-input-row">
        <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMessage()">
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- Join Modal -->
    <div class="modal" id="join-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Join Session</h3>
          <button class="modal-close" onclick="hideJoinModal()">&times;</button>
        </div>
        <p style="color: #888; margin-bottom: 16px;">Enter the access code from the user's notification</p>
        <input type="text" id="access-code-input" placeholder="XXX-XXX-XXX-XXX" style="width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 18px; text-align: center; letter-spacing: 2px; margin-bottom: 16px;">
        <button class="btn btn-primary" style="width: 100%;" onclick="joinWithCode()">Connect</button>
        <p id="join-error" style="color: #ff6b6b; margin-top: 12px; text-align: center;"></p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let token = localStorage.getItem('supportToken');
    let ws = null;
    let currentSessionId = null;

    // Check for magic link token in URL
    const urlParams = new URLSearchParams(window.location.search);
    const verifyToken = urlParams.get('token');
    if (verifyToken) {
      verifyMagicLink(verifyToken);
    } else if (token) {
      verifyExistingToken();
    }

    async function verifyMagicLink(magicToken) {
      try {
        const res = await fetch(`${API_BASE}/api/auth/verify?token=${magicToken}`);
        const data = await res.json();

        if (data.success && data.token) {
          token = data.token;
          localStorage.setItem('supportToken', token);
          window.history.replaceState({}, '', '/');
          showDashboard(data.email);
        } else {
          alert('Invalid or expired link');
        }
      } catch (e) {
        console.error('Verify error:', e);
        alert('Failed to verify link');
      }
    }

    async function verifyExistingToken() {
      try {
        const res = await fetch(`${API_BASE}/api/auth/verify-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await res.json();

        if (data.valid && data.isSupport) {
          showDashboard(data.email);
        } else {
          localStorage.removeItem('supportToken');
          token = null;
        }
      } catch (e) {
        console.error('Token verify error:', e);
      }
    }

    async function requestMagicLink() {
      const email = document.getElementById('email-input').value;
      if (!email) return;

      try {
        const res = await fetch(`${API_BASE}/api/auth/magic-link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('login-message').textContent = data.message;

          // Dev mode - auto-redirect
          if (data.devUrl) {
            setTimeout(() => window.location.href = data.devUrl, 1000);
          }
        } else {
          document.getElementById('login-message').textContent = data.error || 'Failed to send link';
        }
      } catch (e) {
        document.getElementById('login-message').textContent = 'Failed to send link';
      }
    }

    function showDashboard(email) {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      document.getElementById('user-info').style.display = 'flex';
      document.getElementById('user-email').textContent = email;

      connectWebSocket();
      loadSessions();
      setInterval(loadSessions, 5000);
    }

    function logout() {
      localStorage.removeItem('supportToken');
      token = null;
      if (ws) ws.close();
      window.location.reload();
    }

    function connectWebSocket() {
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

      ws.onopen = () => console.log('WebSocket connected');

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWsMessage(data);
      };

      ws.onclose = () => {
        console.log('WebSocket closed, reconnecting...');
        setTimeout(connectWebSocket, 3000);
      };
    }

    function handleWsMessage(data) {
      switch (data.type) {
        case 'auth:success':
          currentSessionId = data.sessionId;
          showSupportChat(data);
          break;
        case 'auth:failed':
          document.getElementById('join-error').textContent = data.error;
          break;
        case 'chat:message':
          addChatMessage(data.from, data.content, data.timestamp);
          break;
        case 'user:disconnected':
          addChatMessage('system', 'User has disconnected', new Date().toISOString());
          break;
        case 'command:response':
          console.log('Command response:', data);
          break;
      }
    }

    async function loadSessions() {
      try {
        const res = await fetch(`${API_BASE}/api/support/sessions`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();

        if (data.success) {
          renderSessions(data.sessions);
          updateStats(data.sessions);
        }
      } catch (e) {
        console.error('Load sessions error:', e);
      }
    }

    function renderSessions(sessions) {
      const container = document.getElementById('sessions-list');

      if (sessions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span>üí§</span>
            <p>No active sessions. Users will appear here when they request help.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = sessions.map(s => `
        <div class="session-card" onclick="viewSession('${s.id}')">
          <div class="session-info">
            <h3>${s.systemSummary || 'Unknown PC'}</h3>
            <p>Started ${new Date(s.createdAt).toLocaleTimeString()} ‚Ä¢ ${s.messageCount} messages</p>
          </div>
          <span class="session-status ${s.status}">${s.status === 'waiting' ? 'Waiting' : 'Active'}</span>
        </div>
      `).join('');
    }

    function updateStats(sessions) {
      document.getElementById('stat-active').textContent = sessions.length;
      document.getElementById('stat-waiting').textContent = sessions.filter(s => s.status === 'waiting').length;
      document.getElementById('stat-connected').textContent = sessions.filter(s => s.status === 'active').length;
    }

    function showJoinModal() {
      document.getElementById('join-modal').classList.add('active');
      document.getElementById('access-code-input').focus();
    }

    function hideJoinModal() {
      document.getElementById('join-modal').classList.remove('active');
      document.getElementById('join-error').textContent = '';
    }

    function joinWithCode() {
      const code = document.getElementById('access-code-input').value;
      if (!code) return;

      ws.send(JSON.stringify({
        type: 'support:auth',
        code: code,
        token: token
      }));
    }

    async function viewSession(sessionId) {
      try {
        const res = await fetch(`${API_BASE}/api/support/sessions/${sessionId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();

        if (data.success) {
          // If session is waiting, try to connect
          if (data.session.status === 'waiting') {
            // Need access code - show in UI
            alert('Session is waiting. Use "Join with Code" to connect.');
          }
        }
      } catch (e) {
        console.error('View session error:', e);
      }
    }

    function showSupportChat(data) {
      hideJoinModal();
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('support-chat').classList.add('active');
      document.getElementById('chat-session-id').textContent = `Session: ${data.sessionId.substring(0, 8)}...`;

      // Show system info
      const grid = document.getElementById('system-info-grid');
      if (data.systemInfo) {
        grid.innerHTML = Object.entries(data.systemInfo).map(([key, val]) => `
          <div class="info-item">
            <label>${key}</label>
            <span>${typeof val === 'object' ? JSON.stringify(val) : val}</span>
          </div>
        `).join('');
      }

      // Show initial message
      if (data.userMessage) {
        addChatMessage('user', data.userMessage, new Date().toISOString());
      }
    }

    function leaveSession() {
      currentSessionId = null;
      document.getElementById('support-chat').classList.remove('active');
      document.getElementById('dashboard').classList.add('active');
      document.getElementById('chat-messages').innerHTML = '';
      loadSessions();
    }

    function sendMessage() {
      const input = document.getElementById('chat-input');
      const content = input.value.trim();
      if (!content || !currentSessionId) return;

      ws.send(JSON.stringify({
        type: 'chat:message',
        content: content
      }));

      addChatMessage('support', content, new Date().toISOString());
      input.value = '';
    }

    function addChatMessage(from, content, timestamp) {
      const container = document.getElementById('chat-messages');
      const div = document.createElement('div');
      div.className = `message ${from}`;
      div.innerHTML = `
        ${content}
        <div class="message-meta">${new Date(timestamp).toLocaleTimeString()}</div>
      `;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
  </script>
</body>
</html>
