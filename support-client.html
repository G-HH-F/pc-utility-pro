<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PC Utility Pro - Remote Support</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { color: #8b5cf6; margin-bottom: 10px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .connect-form {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 30px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 20px;
    }
    .connect-form.hidden { display: none; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #aaa; font-size: 14px; }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
    }
    input:focus { outline: none; border-color: #8b5cf6; }
    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .status { text-align: center; padding: 10px; color: #888; }
    .status.connected { color: #10b981; }
    .status.error { color: #ef4444; }

    .chat-container {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      display: none;
      flex-direction: column;
      height: 70vh;
    }
    .chat-container.active { display: flex; }
    .chat-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chat-header h2 { flex: 1; font-size: 18px; }
    .online-badge {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
    }
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
    }
    .msg.from-support {
      align-self: flex-end;
      background: #667eea;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .msg.from-user {
      align-self: flex-start;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      border-bottom-left-radius: 4px;
    }
    .msg img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      cursor: pointer;
      display: block;
      margin-bottom: 5px;
    }
    .msg .time {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 4px;
      display: block;
    }
    .chat-input-row {
      padding: 15px 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .photo-btn {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .photo-btn:hover { background: rgba(255,255,255,0.2); }
    .photo-btn svg { width: 20px; height: 20px; stroke: #aaa; fill: none; stroke-width: 2; }
    .chat-input-row input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .send-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    .disconnect-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: #888;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .disconnect-btn:hover { border-color: #ef4444; color: #ef4444; }
  </style>
</head>
<body>
  <h1>PC Utility Pro</h1>
  <p class="subtitle">Remote Support Connection</p>

  <div class="connect-form" id="connect-form">
    <div class="form-group">
      <label>Server Address</label>
      <input type="text" id="server-address" placeholder="e.g., 192.168.1.100:8877 or yourpc.loca.lt" />
    </div>
    <div class="form-group">
      <label>Access Code</label>
      <input type="password" id="access-code" placeholder="Enter the access code" />
    </div>
    <button class="btn" id="connect-btn">Connect</button>
    <div class="status" id="status"></div>
  </div>

  <div class="chat-container" id="chat-container">
    <div class="chat-header">
      <h2>Remote Support Chat</h2>
      <span class="online-badge">Connected</span>
      <button class="disconnect-btn" id="disconnect-btn">Disconnect</button>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input-row">
      <div class="photo-btn" id="photo-btn">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        <input type="file" id="photo-input" accept="image/*" style="display: none;" />
      </div>
      <input type="text" id="message-input" placeholder="Type a message..." />
      <button class="send-btn" id="send-btn">Send</button>
    </div>
  </div>

  <script>
    let ws = null;
    const statusEl = document.getElementById('status');
    const connectForm = document.getElementById('connect-form');
    const chatContainer = document.getElementById('chat-container');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');

    // Photo cache for loaded images
    const photoCache = {};

    document.getElementById('connect-btn').addEventListener('click', connect);
    document.getElementById('disconnect-btn').addEventListener('click', disconnect);
    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('photo-btn').addEventListener('click', () => {
      document.getElementById('photo-input').click();
    });
    document.getElementById('photo-input').addEventListener('change', sendPhoto);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    function connect() {
      const address = document.getElementById('server-address').value.trim();
      const code = document.getElementById('access-code').value;

      if (!address || !code) {
        showStatus('Please enter server address and access code', 'error');
        return;
      }

      showStatus('Connecting...', '');

      try {
        ws = new WebSocket(`ws://${address}`);

        ws.onopen = () => {
          showStatus('Authenticating...', '');
          ws.send(JSON.stringify({ type: 'auth', code }));
        };

        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data);

          if (msg.type === 'auth') {
            if (msg.success) {
              showStatus('Connected!', 'connected');
              connectForm.classList.add('hidden');
              chatContainer.classList.add('active');
            } else {
              showStatus('Invalid access code', 'error');
              ws.close();
            }
          } else if (msg.type === 'chat-history') {
            // Load chat history
            chatMessages.innerHTML = '';
            msg.data.forEach(m => appendMessage(m));
          } else if (msg.type === 'chat-message') {
            // New message from user
            appendMessage(msg.data);
          } else if (msg.type === 'chat-message-sent') {
            // Confirmation of our message
            appendMessage(msg.data);
          } else if (msg.type === 'photo-data') {
            // Photo data received
            photoCache[msg.photoId] = msg.data;
            const img = document.querySelector(`img[data-photo-id="${msg.photoId}"]`);
            if (img) img.src = msg.data;
          }
        };

        ws.onerror = () => {
          showStatus('Connection failed', 'error');
        };

        ws.onclose = () => {
          if (chatContainer.classList.contains('active')) {
            showStatus('Disconnected', 'error');
            chatContainer.classList.remove('active');
            connectForm.classList.remove('hidden');
          }
        };
      } catch (e) {
        showStatus('Invalid address', 'error');
      }
    }

    function disconnect() {
      if (ws) ws.close();
      chatContainer.classList.remove('active');
      connectForm.classList.remove('hidden');
      showStatus('', '');
    }

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !ws) return;

      ws.send(JSON.stringify({ type: 'chat-message', text, isPhoto: false }));
      messageInput.value = '';
    }

    function sendPhoto(e) {
      if (!e.target.files || !e.target.files[0] || !ws) return;

      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = (event) => {
        const photoData = event.target.result;
        const caption = messageInput.value.trim();

        ws.send(JSON.stringify({
          type: 'chat-message',
          text: caption || '',
          isPhoto: true,
          photoData
        }));

        messageInput.value = '';
      };

      reader.readAsDataURL(file);
      e.target.value = '';
    }

    function appendMessage(msg) {
      const div = document.createElement('div');
      div.className = `msg from-${msg.from}`;

      let content = '';
      if (msg.isPhoto && msg.photoPath) {
        if (msg.from === 'support' && msg.photoData) {
          // We sent this photo, we have the data
          content += `<img src="${msg.photoData}" />`;
        } else if (photoCache[msg.photoId]) {
          content += `<img src="${photoCache[msg.photoId]}" />`;
        } else {
          // Request photo from server
          content += `<img data-photo-id="${msg.photoId}" src="" style="min-width:100px;min-height:100px;background:#333;" />`;
          if (ws && ws.readyState === 1) {
            ws.send(JSON.stringify({ type: 'get-photo', photoPath: msg.photoPath, photoId: msg.photoId }));
          }
        }
      }
      if (msg.message) {
        content += `<span>${msg.message}</span>`;
      }

      const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      content += `<span class="time">${time}</span>`;

      div.innerHTML = content;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = 'status ' + type;
    }
  </script>
</body>
</html>
